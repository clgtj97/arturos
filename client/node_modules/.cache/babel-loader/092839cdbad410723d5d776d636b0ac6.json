{"ast":null,"code":"// Copyright 2012 Mark Cavage, Inc.  All rights reserved.\n'use strict';\n\nvar assert = require('assert-plus');\n\nvar shallowCopy = require('./utils/shallowCopy'); ///--- API\n\n/**\n * Sets up a child [bunyan](https://github.com/trentm/node-bunyan) logger with\n * the current request id filled in, along with any other parameters you define.\n *\n * You can pass in no options to this, in which case only the request id will be\n * appended, and no serializers appended (this is also the most performant); the\n * logger created at server creation time will be used as the parent logger.\n * This logger can be used normally, with [req.log](#request-api).\n *\n * This plugin does _not_ log each individual request. Use the Audit Logging\n * plugin or a custom middleware for that use.\n *\n * @public\n * @function requestLogger\n * @param    {Object}   [options] - an options object\n * @param    {Array}    [options.headers] - A list of headers to transfer from\n *                                  the request to top level props on the log.\n * @returns  {Function} Handler\n * @example\n * server.use(restify.plugins.requestLogger({\n *     properties: {\n *         foo: 'bar'\n *     },\n *     serializers: {...}\n * }));\n */\n\n\nfunction requestLogger(options) {\n  assert.optionalObject(options);\n  var opts = options || {};\n  var props;\n\n  if (opts.properties) {\n    props = shallowCopy(opts.properties);\n  } else {\n    props = {};\n  }\n\n  if (opts.serializers) {\n    props.serializers = opts.serializers;\n  }\n\n  var headersToCopy = opts.headers || [];\n  return function bunyan(req, res, next) {\n    if (!req.log && !opts.log) {\n      next();\n      return;\n    }\n\n    var log = req.log || opts.log;\n    props.req_id = req.getId();\n    headersToCopy.forEach(function forEach(k) {\n      if (req.headers[k]) {\n        props[k] = req.headers[k];\n      }\n    });\n    req.log = log.child(props, props.serializers ? false : true);\n\n    if (props.req_id) {\n      delete props.req_id;\n    }\n\n    next();\n  };\n} ///--- Exports\n\n\nmodule.exports = requestLogger;","map":null,"metadata":{},"sourceType":"script"}